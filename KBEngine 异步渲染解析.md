## KBEngine 异步渲染解析

​		目前在**KBEngine**中可以配置是否启用多线程，所谓的异步渲染就是多线程渲染，一般情况下，会有**渲染线程**（底层3D API都是在此调用）、引擎线程、主线程等等。

​		那么在异步渲染中是怎样通信的呢？之间的同步是怎么做的？那我们那就接着往下看：

​		主要有涉及三个方面：

1. 交换资源帧缓冲区的同步
2. 多编码器的同步
3. 引擎线程和渲染线程的同步

#### 交换帧缓冲区的同步

​		除了在后面线程交换缓冲区会影响同步，还有在设置相应帧数据时，也同时需要注意同步问题，这是因为**设置相应帧数据，也是设置到m_submitFrame这个变量，而这个变量相关的操作都会影响，故在设置这些数据、交换缓冲区数据都需要注意同步**，在KBEngine中是使用临界资源来实现，在设置相关KBFrame这个类中相关成员的设置都需要设置临界资源，包括但不限于：创建命令、设置相关的顶点缓冲区、索引缓冲区、程序、着色器、纹理、帧缓冲区等等。

#### 多编码器的同步

​		在KBEngine中，默认使用一个编码器，而KBEngine引擎中，可以设置最多**八个编码器**，**每个编码器对应一一个线程，可以一次多线程提交到帧缓冲区中**，所以这边需要注意两个方面，一个是编码器提交时的同步，另外在交换缓冲区时；

​		由于多个编码器最终都是写到帧数据中m_submitFrame，那么写到帧数据就有drawItem和相应的uniform buffer，在这个drawItemId时会使用一个**原子操作**，保证不会重复。

​	  在申请编码器时，需要注意编码器不能重复申请，这个时候需要加m_encoderApiLock，防止其他线程重复申请；

​	在交换缓冲区时，需要注意编码器提交完毕才能进行交换缓冲区的操作，这个时候会有**m_encoderEndSem**等待所有信号量提交完毕才可以交换。

####引擎线程和渲染线程的同步

​		在KBEngine中，一帧完整的数据是保存在KBFrame类中，包括命令缓冲区、相关的纹理、顶点等数据，在交换缓冲区时，需要考虑到引擎线程和渲染线程的同步。

​		首先，在渲染线程渲染时，需要等待引擎线程是否准备好数据，在KBEngine中使用**信号量m_apiSem**，引擎线程准备好数据，发送一个信号量，在渲染线程中会一直等待信号量，除非接收到信号量才开始渲染。

  		其次，在引擎线程交换缓冲区时，需要等待渲染线程是否渲染完毕，为什么双方都需要等待呢？这是因为**在渲染线程中使用m_renderFrame，在引擎线程中使用m_submitFrame，而交换缓冲区会改变这两个缓冲区内容，所以需要做同步**。如果渲染线程渲染好了，发送信号量，这时引擎线程接收到信号量，就可以交换缓冲区了。

![bgfx1](/Users/sumingnan/ibook/EngineLearn/bgfx/image/bgfx1.png)